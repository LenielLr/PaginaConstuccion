<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Proyecto - Constructora Premium</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🏗️</text></svg>">
</head>
<body>
    <header>
        <h1>✏️ Editar Proyecto</h1>
        <nav>
            <a href="{{ url_for('home') }}">🏠 Volver a la Galería</a>
            <a href="{{ url_for('ver_proyecto', proyecto_id=proyecto.id) }}" class="btn-header">👁️ Ver Detalles</a>
            {% if session.get('logged_in') %}
                <a href="{{ url_for('logout') }}" class="btn-header" style="background: rgba(239, 68, 68, 0.2); color: var(--danger) !important;">🚪 Salir</a>
            {% endif %}
        </nav>
    </header>

    <main>
        <form id="editar-form" action="{{ url_for('editar', id=proyecto.id) }}" method="POST" enctype="multipart/form-data" class="formulario">
            <div class="form-header">
                <h2>✏️ Editar "{{ proyecto.nombre }}"</h2>
                <p style="color: var(--text-secondary); font-size: 0.95rem; margin-top: 0.5rem;">
                    Modifica la información del proyecto y gestiona sus archivos multimedia
                </p>
            </div>

            <!-- Información básica -->
            <div class="form-group">
                <label for="nombre"><span class="label-icon">🏗️</span> Nombre del Proyecto <span class="required">*</span></label>
                <input type="text" id="nombre" name="nombre" value="{{ proyecto.nombre }}" placeholder="Ej: Torre Residencial Vista Mar" required>
            </div>

            <div class="form-group">
                <label for="descripcion"><span class="label-icon">📋</span> Descripción <span class="required">*</span></label>
                <textarea id="descripcion" name="descripcion" rows="5" placeholder="Describe el proyecto, características principales, ubicación, etc." required>{{ proyecto.descripcion }}</textarea>
                <small class="form-hint">Proporciona una descripción detallada del proyecto</small>
            </div>

            <div class="form-group">
                <label for="ubicacion"><span class="label-icon">📍</span> Ubicación <span class="optional">(Opcional)</span></label>
                <input type="text" id="ubicacion" name="ubicacion" value="{{ proyecto.get('ubicacion', '') }}" placeholder="Ej: Av. Principal 123, Ciudad">
            </div>

            <div class="form-group">
                <label for="cliente"><span class="label-icon">👤</span> Cliente <span class="optional">(Opcional)</span></label>
                <input type="text" id="cliente" name="cliente" value="{{ proyecto.get('cliente', '') }}" placeholder="Ej: Inmobiliaria XYZ">
            </div>

            {% if proyecto.media and proyecto.media|length > 0 %}
            <div class="section-divider">
                <h3 class="section-title"><span>📁</span> Archivos Actuales ({{ proyecto.media|length }})</h3>
                <div class="media-gallery">
                    {% for media in proyecto.media %}
                    <div class="media-item">
                        {% if media.tipo == 'video' %}
                            <video src="{{ media.url }}" muted></video>
                        {% else %}
                            <img src="{{ media.url }}" alt="{{ media.nombre }}">
                        {% endif %}
                        <div class="media-item-actions">
                            <span class="media-item-info">{{ media.tipo|upper }} - {{ media.nombre[:20] }}{% if media.nombre|length > 20 %}...{% endif %}</span>
                            <button type="button" class="btn-delete-media" onclick="eliminarMedia('{{ url_for('eliminar_media', proyecto_id=proyecto.id, media_index=loop.index0) }}')">🗑️</button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <div class="form-divider"><span>Agregar Nuevos Archivos</span></div>

            <div class="form-group">
                <label for="archivos"><span class="label-icon">📤</span> Subir Nuevos Archivos <span class="optional">(Opcional)</span></label>
                <div class="file-input-wrapper">
                    <input type="file" id="archivos" name="archivos" accept="image/*,video/*" multiple>
                    <div class="file-input-display">
                        <span class="file-icon">📁</span>
                        <span class="file-text">Selecciona imágenes y/o videos (múltiples archivos)</span>
                        <span class="file-button">Explorar</span>
                    </div>
                </div>
                <small class="form-hint">
                    💡 Puedes seleccionar múltiples archivos manteniendo presionado Ctrl (Windows) o Cmd (Mac)<br>
                    📸 Formatos: JPG, PNG, GIF<br>
                    🎥 Videos: MP4, MOV, WEBM, AVI
                </small>
            </div>

            <div id="preview-container" class="preview-container"></div>

            <div class="form-actions">
                <button type="submit" class="btn-submit"><span>💾 Guardar Cambios</span></button>
                <a href="{{ url_for('ver_proyecto', proyecto_id=proyecto.id) }}" class="btn-cancel"><span>❌ Cancelar</span></a>
            </div>
        </form>

        <!-- Info adicional -->
        <div style="max-width: 700px; margin: 2rem auto; padding: 1.5rem; background: var(--surface); border-radius: 12px; border: 1px solid var(--border);">
            <h3 style="color: var(--primary); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;"><span>📊</span> Información del Proyecto</h3>
            <div style="display: grid; gap: 0.75rem; color: var(--text-secondary); font-size: 0.95rem;">
                <div style="display: flex; justify-content: space-between;"><span><strong>ID:</strong></span><span>{{ proyecto.id }}</span></div>
                {% if proyecto.get('fecha_agregado') %}
                <div style="display: flex; justify-content: space-between;"><span><strong>Fecha:</strong></span><span>{{ proyecto.fecha_agregado }}</span></div>
                {% endif %}
                <div style="display: flex; justify-content: space-between;"><span><strong>Vistas:</strong></span><span>{{ proyecto.get('vistas', 0) }}</span></div>
                <div style="display: flex; justify-content: space-between;"><span><strong>Total archivos:</strong></span><span>{{ proyecto.media|length }}</span></div>
            </div>
        </div>
    </main>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        // Script específico para la página de edición
        const fileInput = document.getElementById('archivos');
        const fileText = document.querySelector('.file-text');
        const previewContainer = document.getElementById('preview-container');

        fileInput.addEventListener('change', () => {
            const files = fileInput.files;
            previewContainer.innerHTML = "";
            if (files.length > 0) {
                fileText.textContent = `${files.length} archivo(s) seleccionado(s)`;
                for (const file of files) {
                    const fileType = file.type.split('/')[0];
                    const el = document.createElement(fileType === 'video' ? 'video' : 'img');
                    el.src = URL.createObjectURL(file);
                    el.classList.add('preview-item');
                    if (fileType === 'video') el.controls = true;
                    previewContainer.appendChild(el);
                }
            } else {
                fileText.textContent = 'Selecciona imágenes y/o videos (múltiples archivos)';
            }
        });

        // Eliminar archivo sin anidar forms
        function eliminarMedia(url) {
            if (confirm('¿Eliminar este archivo?')) {
                fetch(url, { method: 'POST' })
                    .then(res => res.ok ? location.reload() : alert('Error al eliminar archivo'))
                    .catch(() => alert('Error de conexión'));
            }
        }

        // Validación antes de enviar
        document.getElementById('editar-form').addEventListener('submit', (e) => {
            const nombre = document.getElementById('nombre').value.trim();
            const descripcion = document.getElementById('descripcion').value.trim();
            if (nombre.length < 3) {
                e.preventDefault();
                alert('❌ El nombre del proyecto debe tener al menos 3 caracteres');
                return;
            }
            if (descripcion.length < 10) {
                e.preventDefault();
                alert('❌ La descripción debe tener al menos 10 caracteres');
                return;
            }
        });
    </script>
</body>
</html>